// ------------------------------------------------------
// Addis Music Streaming Platform + Better Auth
// Database: PostgreSQL
// ORM: Prisma 5+
// ------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------
// ENUMS
// ------------------------------------------------------

enum SubscriptionPlan {
  FREE
  PREMIUM
  FAMILY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PENDING
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
}

// ------------------------------------------------------
// BETTER AUTH MODELS
// (Base schema compatible with better-auth)
// ------------------------------------------------------

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  role          String
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?

  @@unique([email])
  @@map("user")

  // Relations
  accounts      Account[]
  sessions      Session[]
  profile       UserProfile?
  playlists     Playlist[]
  likedTracks   TrackLike[]
  playHistory   PlayHistory[]
  payments      Payment[]
  devices       DeviceSession[]
  subscriptions Subscription[]
  follows       UserFollow[]    @relation("Following")
  followers     UserFollow[]    @relation("Followers")
  artistFollows ArtistFollow[]
  adImpressions AdImpression[]
  preference    UserPreference?
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}


// ------------------------------------------------------
// USER PROFILE (App-specific fields)
// ------------------------------------------------------

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  displayName String?
  firstName   String?
  lastName    String?
  country     String?
  bio         String?
  birthDay    DateTime?
  avatarUrl   String?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
}

model UserPreference {
  id            String      @id @default(uuid())
  userId      String   @unique
  favoriteGenres String[]
  favoriteArtists String[]
  moodPreference String?
  language       String?
  streamQuality  String? // "low" | "medium" | "high"
  notifications  Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id])
}

// ------------------------------------------------------
// ARTISTS / ALBUMS / TRACKS
// ------------------------------------------------------

model Artist {
  id         String    @id @default(uuid())
  name       String
  bio        String?
  isVerified Boolean   @default(true)
  imageUrl   String?
  genres     String[]
  country    String?
  createdAt  DateTime  @default(now())

  albums     Album[]
  tracks     Track[]
  followers  ArtistFollow[]
}

model Album {
  id          String    @id @default(uuid())
  title       String
  releaseDate DateTime
  coverUrl    String?
  genreId     String?
  artistId    String
  description String?
  credit      String?
  createdAt   DateTime  @default(now())

  artist      Artist    @relation(fields: [artistId], references: [id])
  tracks      Track[]
  genre       Genre?    @relation(fields: [genreId], references: [id])
}


model Track {
  id           String     @id @default(uuid())
  title        String
  durationSec  Float
  audioUrl     String
  artistId     String
  albumId      String?
  genreId      String?
  coverUrl     String?
  trackNumber  Int?
  releaseDate  DateTime   @default(now())
  description  String?
  credit       String?

  tags         String[]   @default([])
  popularity   Int        @default(0)
  createdAt    DateTime   @default(now())

  // Embeddings (store as Bytes or Json for now)
  metaDataEmbedding Json?
  sonicEmbedding    Json?

  artist       Artist     @relation(fields: [artistId], references: [id])
  album        Album?     @relation(fields: [albumId], references: [id])
  genre        Genre?     @relation(fields: [genreId], references: [id])
  likes        TrackLike[]
  playHistory  PlayHistory[]
  adTracks     AdTrack[]
  playlistItems PlaylistItem[]
}


// ------------------------------------------------------
// PLAYLISTS / LIKES / HISTORY
// ------------------------------------------------------

model Playlist {
  id          String        @id @default(uuid())
  title       String
  description String?
  coverUrl    String?
  isPublic    Boolean       @default(true)
  userId      String
  createdAt   DateTime      @default(now())

  user        User          @relation(fields: [userId], references: [id])
  items       PlaylistItem[]
}

model PlaylistItem {
  id         String     @id @default(uuid())
  playlistId String
  trackId    String
  position   Int
  addedAt    DateTime   @default(now())

  playlist   Playlist   @relation(fields: [playlistId], references: [id])
  track      Track      @relation(fields: [trackId], references: [id])
}

model TrackLike {
  id        String     @id @default(uuid())
  userId    String
  trackId   String
  createdAt DateTime   @default(now())

  user      User       @relation(fields: [userId], references: [id])
  track     Track      @relation(fields: [trackId], references: [id])

  @@unique([userId, trackId])
}

model PlayHistory {
  id        String     @id @default(uuid())
  userId    String
  trackId   String
  playedAt  DateTime   @default(now())
  duration  Int?
  deviceId  String?

  user      User       @relation(fields: [userId], references: [id])
  track     Track      @relation(fields: [trackId], references: [id])
  device    DeviceSession? @relation(fields: [deviceId], references: [id])
}

// ------------------------------------------------------
// FOLLOWS
// ------------------------------------------------------

model UserFollow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("Following", fields: [followerId], references: [id])
  following   User     @relation("Followers", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
}

model ArtistFollow {
  id        String   @id @default(uuid())
  userId    String
  artistId  String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  artist    Artist   @relation(fields: [artistId], references: [id])

  @@unique([userId, artistId])
}

// ------------------------------------------------------
// SUBSCRIPTIONS & PAYMENTS
// ------------------------------------------------------

model Subscription {
  id           String              @id @default(uuid())
  userId       String
  plan         SubscriptionPlan
  status       SubscriptionStatus
  startDate    DateTime            @default(now())
  endDate      DateTime?
  renewalDate  DateTime?
  createdAt    DateTime            @default(now())

  user         User                @relation(fields: [userId], references: [id])
  payments     Payment[]
}

model Payment {
  id             String           @id @default(uuid())
  userId         String
  subscriptionId String?
  amount         Decimal
  currency       String
  provider       String           // e.g. "Tellebirr", "Chapa"
  status         PaymentStatus
  createdAt      DateTime         @default(now())

  user           User             @relation(fields: [userId], references: [id])
  subscription   Subscription?    @relation(fields: [subscriptionId], references: [id])
}

// ------------------------------------------------------
// ADVERTISEMENTS
// ------------------------------------------------------

model Advertisement {
  id          String          @id @default(uuid())
  title       String
  imageUrl    String?
  videoUrl    String?
  targetUrl   String
  startDate   DateTime
  endDate     DateTime
  budget      Decimal
  active      Boolean         @default(true)
  advertiser  String
  createdAt   DateTime        @default(now())

  targets     AdTarget[]
  impressions AdImpression[]
  tracks      AdTrack[]
}

model AdTarget {
  id         String          @id @default(uuid())
  adId       String
  country    String?
  genreId    String?
  minAge     Int?
  maxAge     Int?
  gender     String?
  deviceType String?

  advertisement Advertisement @relation(fields: [adId], references: [id])
}

model AdTrack {
  id        String          @id @default(uuid())
  adId      String
  trackId   String

  advertisement Advertisement @relation(fields: [adId], references: [id])
  track         Track         @relation(fields: [trackId], references: [id])
}

model AdImpression {
  id        String          @id @default(uuid())
  adId      String
  userId    String?
  shownAt   DateTime        @default(now())
  clicked   Boolean         @default(false)

  advertisement Advertisement @relation(fields: [adId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
}

// ------------------------------------------------------
// GENRES / TAGS / DEVICES
// ------------------------------------------------------

model Genre {
  id       String   @id @default(uuid())
  name     String   @unique
  tracks   Track[]
  albums   Album[]
}

model Tag {
  id      String   @id @default(uuid())
  name    String   @unique
}

model DeviceSession {
  id          String    @id @default(uuid())
  userId      String
  deviceType  String
  lastActive  DateTime  @default(now())
  pushToken   String?
  ipAddress   String?

  user        User      @relation(fields: [userId], references: [id])
  playHistories PlayHistory[]
}
